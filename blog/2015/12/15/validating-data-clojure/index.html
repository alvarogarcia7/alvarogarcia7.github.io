
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Validating CSV Data in Clojure - The long way through Software Craftsmanship</title>
  <meta name="author" content="alvaro garcia">

  
  <meta name="description" content="At a client, we have CSVs of data that can be simplified to this 1: 1
2
3
4
5
6
(def data [ [&quot;total&quot; 6 8 13] [&quot;0&quot; 1 2 3] [&quot;0 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://alvarogarcia7.github.io/blog/2015/12/15/validating-data-clojure">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <link href="/atom.xml" rel="alternate" title="The long way through Software Craftsmanship" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-41008374-3', 'auto');
    ga('send', 'pageview');

  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">The long way through Software Craftsmanship</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><script type="text/javascript">
    function addCustomSite(form_) {
        var input = $(form_).find("input")[0];
        input.value = "site:alvarogarcia7.github.io " + input.value;
    }
</script>

<ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get" onsubmit="javascript: addCustomSite(this);">
  <fieldset role="search">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/talks">Talks / Events</a></li>
  <li><a href="/blog/categories">Categories</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Validating CSV Data in Clojure</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-12-15T10:52:28+00:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>15</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:52 am</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>At a client, we have CSVs of data that can be simplified to this <sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='lisp'><span class='line'><span class="p">(</span><span class="nv">def</span> <span class="nv">data</span> <span class="nv">[</span>
</span><span class='line'>           <span class="nv">[</span><span class="s">&quot;total&quot;</span> <span class="mi">6</span> <span class="mi">8</span> <span class="nv">13]</span>
</span><span class='line'>           <span class="nv">[</span><span class="s">&quot;0&quot;</span>     <span class="mi">1</span> <span class="mi">2</span> <span class="nv">3]</span>
</span><span class='line'>           <span class="nv">[</span><span class="s">&quot;0&quot;</span>     <span class="mi">2</span> <span class="mi">0</span> <span class="nv">4]</span>
</span><span class='line'>           <span class="nv">[</span><span class="s">&quot;0&quot;</span>     <span class="mi">3</span> <span class="mi">0</span> <span class="nv">6]</span>
</span><span class='line'>          <span class="nv">]</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this case, some of the row named <code>total</code> is the sum of the rest of the rows, but only for some columns (second and fourth). We do not want to get rid of the columns, as they need to be printed at the end.</p>

<p>This is what we need to validate:</p>

<p><code>sum (rest [1]) = total [1]</code></p>

<p><code>sum (rest [3]) = total [3]</code></p>

<p>this could be written as a one-off program but a better alternative for us was to write a program and let users decide what columns to validate. In the future, power users will write their own validations <sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>, thus creating an environment where users are no longer dependent on programmers as coupling business users to programmers does not scale.</p>

<h2>Implementation</h2>

<p>The full <a href="https://github.com/alvarogarcia7/clojure-simple-sessions/blob/master/test/simple/check-data-with-hofs.clj">source code is here</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='lisp'><span class='line'><span class="p">(</span><span class="nv">defn</span> <span class="nv">sum-eq-total</span> <span class="nv">[selector</span> <span class="nv">dataset]</span>
</span><span class='line'>  <span class="p">(</span><span class="nv">letfn</span> <span class="nv">[</span><span class="p">(</span><span class="nv">total-and-rest</span> <span class="nv">[coll]</span>
</span><span class='line'>             <span class="nv">[</span><span class="p">(</span><span class="nb">first</span> <span class="nv">coll</span><span class="p">)</span> <span class="p">(</span><span class="nb">rest</span> <span class="nv">coll</span><span class="p">)</span><span class="nv">]</span><span class="p">)</span><span class="nv">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let</span> <span class="nv">[[total</span> <span class="nv">rest-dataset]</span> <span class="p">(</span><span class="nv">total-and-rest</span> <span class="nv">dataset</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">selected-total</span> <span class="p">(</span><span class="nv">selector</span> <span class="nv">total</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">selected-column</span> <span class="p">(</span><span class="nb">map</span> <span class="nv">selector</span> <span class="nv">rest-dataset</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">sum-of-column</span> <span class="p">(</span><span class="nb">reduce</span> <span class="nb">+</span> <span class="nv">selected-column</span><span class="p">)</span><span class="nv">]</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">=</span> <span class="nv">selected-total</span> <span class="nv">sum-of-column</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nv">defn</span> <span class="nv">validate-columns</span> <span class="nv">[indices</span> <span class="nv">data]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let</span> <span class="nv">[generate-selector</span> <span class="o">#(</span><span class="nv">fn</span> <span class="nv">[dataset]</span> <span class="p">(</span><span class="nb">nth</span> <span class="nv">dataset</span> <span class="nv">%</span><span class="p">))</span>
</span><span class='line'>         <span class="nv">selectors</span> <span class="p">(</span><span class="nb">map</span> <span class="nv">generate-selector</span> <span class="nv">indices</span><span class="p">)</span>
</span><span class='line'>         <span class="nv">check-selector</span> <span class="o">#(</span><span class="nv">sum-eq-total</span> <span class="nv">%</span> <span class="nv">data</span><span class="p">)</span><span class="nv">]</span>
</span><span class='line'>         <span class="p">(</span><span class="nb">map</span> <span class="nv">check-selector</span> <span class="nv">selectors</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>We define the domain concept of <code>selector</code> for pointing to a dataset column</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='lisp'><span class='line'><span class="nv">generate-selector</span> <span class="o">#(</span><span class="nv">fn</span> <span class="nv">[dataset]</span> <span class="p">(</span><span class="nb">nth</span> <span class="nv">dataset</span> <span class="nv">%</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>This expression creates selectors based on a given index. It is a lambda that returns a function, thus being a HOF</p>

<p>Users can use the application in this fashion:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='lisp'><span class='line'><span class="nv">simple.core=&gt;</span> <span class="p">(</span><span class="nv">validate-columns</span> <span class="nv">[1</span> <span class="nv">3]</span> <span class="nv">data</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nv">true</span> <span class="nv">true</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The full <a href="https://github.com/alvarogarcia7/clojure-simple-sessions/blob/master/test/simple/check-data-with-hofs.clj">source code is here</a></p>

<h2>Conclusion</h2>

<p>Working on the REPL for this problem has been a very good idea, but working in a spreadsheet software has been even better. Even faster feedback cycle <sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup>.</p>

<p>The inclusion of the HOF for validating the data has paid its cost (good RoI)</p>

<p>Do not limit what your users can do, let them decide but do not complicate things unnecessarily. Know when to stop adding features and limit work to prevent YAGNI.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>for more information and a spike on reading CSV data in clojure, <a href="https://github.com/alvarogarcia7/clojure-simple-sessions/blob/master/src/simple/check-media-csv.clj">this spike</a> may be useful<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p>for the time being, there are no power users and no need to enable these custom validators. Doing it now would be YAGNI<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
<li id="fn:3">
<p>in the case here, the data and business rules are so simple that there is no need for this software.<a href="#fnref:3" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">alvaro garcia</span></span>

      




<time class='entry-date' datetime='2015-12-15T10:52:28+00:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>15</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:52 am</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/clojure/'>clojure</a>, <a class='category' href='/blog/categories/csv/'>csv</a>, <a class='category' href='/blog/categories/hof/'>hof</a>, <a class='category' href='/blog/categories/idea-for-another-post/'>idea-for-another-post</a>, <a class='category' href='/blog/categories/lambda/'>lambda</a>, <a class='category' href='/blog/categories/repl/'>repl</a>, <a class='category' href='/blog/categories/repl-based-development/'>repl-based-development</a>, <a class='category' href='/blog/categories/selector/'>selector</a>, <a class='category' href='/blog/categories/validation/'>validation</a>, <a class='category' href='/blog/categories/yagni/'>yagni</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://alvarogarcia7.github.io/blog/2015/12/15/validating-data-clojure/" data-via="" data-counturl="http://alvarogarcia7.github.io/blog/2015/12/15/validating-data-clojure/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/12/08/clojure-and-the-macro-and/" title="Previous Post: Clojure and the macro and">&laquo; Clojure and the macro and</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/12/31/books-read-in-2015q4/" title="Next Post: Books read in 2015Q4">Books read in 2015Q4 &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/03/31/books-read-in-2016q1/">Books Read in 2016Q1</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/02/using-tortoise-credentials-from-cli/">Tip: Using Tortoise Credentials in Git CLI</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/02/self-study-in-march-2016/">Self-Study in March 2016</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/01/kata-formulation-find-comments/">Kata Formulation: Find the Comments</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/02/14/two-persons-involved-in-a-git-commit/">Two Persons Involved in a Git Commit, in Github</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/alvarogarcia7">@alvarogarcia7</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'alvarogarcia7',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - alvaro garcia -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'thelongwaythroughsoftwarecraftsmanship';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://alvarogarcia7.github.io/blog/2015/12/15/validating-data-clojure/';
        var disqus_url = 'http://alvarogarcia7.github.io/blog/2015/12/15/validating-data-clojure/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
